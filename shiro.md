# 权限管理概述

基本上只要由用户参与的系统都有权限管理，它属于系统安全的范畴，实现了对用户访问系统的控制，**按照安全策略或规则控制用户只能访问自己权限内的资源。**

权限管理包含：**身份认证**及**授权**两部分，简称为认证授权，对于需要访问资源的用户进行身份认证，认证通过为用户授予访问该资源的权限。

## 身份认证

### 概念

即判断一个用户是否为合法用户的一个处理过程。

常用的认证方式为：

1. 口令密码
2. 指纹
3. 证书

### 用户认证的流程

![image-20200513101813223](C:\Users\14402\AppData\Roaming\Typora\typora-user-images\image-20200513101813223.png)

### 关键对象

1. subject：主体，可以理解为用户，也可能是程序，总之它是访问系统资源的，系统需要对其认证
2. principal：身份信息，通常是唯一的。一个主体可以有多个身份信息，但是只有一个主身份信息（primary principal）
3. credential：凭证信息，可以是密码、指纹、证书等

**主体在进行身份认证时需要提供身份信息和凭证信息。**



## 用户授权

### 概念

认证通过后，系统对用户访问资源进行控制，用户具有资源的访问权限方可访问。即访问控制

### 授权流程

![image-20200513103053483](C:\Users\14402\AppData\Roaming\Typora\typora-user-images\image-20200513103053483.png)

### 关键对象

授权的过程理解：**Who**对**what**进行**how**操作。

+ who：主体，即<font style="color:orange;">subject</font>，subject在认证通过后，系统对其进行访问控制

+ what：即资源（<font style="color:orange;">Resource</font>），subject必须具备相应权限才能访问该资源

  如：用户列表、商品修改菜单、商品名为001的商品详情页

  资源分为**资源类型**和**资源实例**，举例如下：

  + 用户信息就是资源类型，相当于Java类

  + id为001号的用户就是资源实例，相当于对象

+ how：权限/许可（<font style="color:orange;">Permission</font>），是针对资源的权限/许可，如何访问/操作需要定义permission。

  权限比如：用户添加、用户修改、商品删除

### 权限模型

+ **主体（账号，密码）**

+ **资源（资源名称，访问地址）**

+ **权限（权限名称，资源id）**
  + 资源和权限通常合并为一张表：权限（权限名称、资源名称、资源访问地址）

+ **角色（角色名称）**

+ 角色与权限关系（角色id，权限id）

+ 主体与角色关系（主体id，角色id）

  `权限和资源未合并`

  ![image-20200513111150875](C:\Users\14402\AppData\Roaming\Typora\typora-user-images\image-20200513111150875.png)

  `权限与资源合并后`，这是企业开发的通用模型

  ![image-20200513111101495](C:\Users\14402\AppData\Roaming\Typora\typora-user-images\image-20200513111101495.png)

### 分配权限

用户只有分配到相应的权限才可访问相应的资源，权限是对于资源的访问许可。

通常给用户分配资源权限需要将权限信息持久化，比如存储在关系型数据库中。

把用户信息，权限管理，用户分配的权限信息写入数据库中

### 权限控制（授权核心）

+ 基于角色的访问控制

  RBAC (Role Based Access Control),比如系统角色：部门经理、总经理、负责人。。。。

  ```java
  // 模拟基于角色访问控制的伪代码
  // 如果仅仅总经理可以看“用户报表”
  if(user.hasRole("总经理")){
      sout("查看用户报表！");
  }
  
  // 如果变更为部门经理也可以查看用户报表
  if(user.hasRole("总经理") || user.hasRole("部门经理")){
      sout("查看用户报表！");
  }
  ```

  **问题：**角色是针对人划分的，人作为用户在系统中属于活动内容，如果该角色可以访问的资源出现变更，则需要修改源代码

  **结论：**基于角色的访问控制不利于程序的扩展

+ 基于资源的访问控制

  RBAC (Resource Based Access Control)

  资源在系统中是不变的，比如类中的方法，页面的按钮，对资源的访问需要有**permission**

  ```java
  if(user.hasPermission("用户报表查看")){
      sout("查看用户报表！")
  }
  ```

  这样就可以解决用户因角色的变更而带来的更改权限控制的源代码的问题

# 权限管理解决方案

### 粗粒度和细粒度权限

粗粒度权限管理，对**资源类型**的权限管理。

细粒度权限管理，对**资源实例**的权限管理。数据级别的权限管理，可以具体到某个数据对象。

### 实现粗细粒度的权限管理

#### 实现粗粒度权限管理

粗粒度的权限管理比较容易将权限管理的代码抽取出来，在系统架构级别统一处理。例如，通过Spring MVC的拦截器实现授权。

#### 实现细粒度权限管理

**对于细粒度权限管理在数据级别是没有共性的。针对细粒度的权限管理就是业务逻辑的一部分，在业务层处理比较简单。如果将细粒度的权限管理同意在系统架构级别抽取，是比较困难的，即使能成功抽取，也存在扩展性不强的问题**

建议细粒度权限管理在业务层（Service层）处理。

### 基于Url拦截的方式实现

### 基于权限管理框架的方式实现



# 0 基于Url的权限管理

### 0.1 搭建环境

#### 0.1.1 数据库

创建表：用户表、角色表、权限表（权限+资源）、用户角色表、角色权限表

完成权限模型创建

![image-20200513123638958](C:\Users\14402\AppData\Roaming\Typora\typora-user-images\image-20200513123638958.png)



#### 0.1.2 开发环境

jdk1.8 + idea + ssm



# 1 认识shiro

shiro是Java的一个权限管理安全框架，可以用它完成认证、授权、加密、会话管理、与web集成、缓存等

## 1.1 功能简介

+ 核心功能
  1. 认证
  2. 授权
  3. 会话管理
  4. 加密
+ 支持特性
  1. web支持
  2. 缓存
  3. 一致性(多线程情况下)
  4. 测试
  5. "Run As"
  6. Remember Me

## 1.2 架构

![image-20200310014752669](C:\Users\14402\AppData\Roaming\Typora\typora-user-images\image-20200310014752669.png)

![image-20200310015048451](C:\Users\14402\AppData\Roaming\Typora\typora-user-images\image-20200310015048451.png)

![img](https://atts.w3cschool.cn/attachments/image/wk/shiro/3.png)

![image-20200310015417937](C:\Users\14402\AppData\Roaming\Typora\typora-user-images\image-20200310015417937.png)



# 2 基于url权限管理

